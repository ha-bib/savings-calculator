<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kalkulator Target Tabungan</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 72 72'><text y='60' font-size='60'>ğŸ’µ</text></svg>" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/ui-lightness/jquery-ui.min.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #ffffff 0%, #aeffb6 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto; 
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #4caf50, #45a049);
      color: white;
      padding: 30px;
      text-align: center;
      margin-bottom: 25px;
      border-radius: 20px; 
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    
      .content {
        grid: 10px;
      }

    .section-wrap {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      border: 3px solid #c3e5c4;
    }

    .form-group {
      margin-bottom: 25px;
    }
    .mb-1 {
      margin-bottom: 5px !important;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 1rem;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .btn {
      background: linear-gradient(45deg, #4caf50, #45a049);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .btn-tutorial {
      background: linear-gradient(45deg, #a1a1a1, #787878);
      box-shadow: 0 4px 15px rgb(0 0 0 / 30%);
    }

    .btn-tutorial:hover {
      box-shadow: 0 6px 20px rgba(255, 193, 7, 0.5);
    }

    .btn-danger {
      background: linear-gradient(45deg, #d32f2f, #b72020);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
      padding: 10px 15px;
    }

    .btn-danger:hover {
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }

    .target-item {
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 25px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: move;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .target-item:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .target-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .target-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
    }

    .target-amount {
      font-size: 1.1rem;
      color: #4caf50;
      font-weight: 600;
    }

    .drag-handle {
      color: #999;
      font-size: 1.2rem;
      cursor: move; 
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: #f8f9fa;
      margin: 50px auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { 
        transform: translateY(-50px);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e1e5e9;
    }

    .modal-header h2 {
      margin: 0;
      color: #333;
      font-size: 1.5rem;
    }

    .close-modal {
      font-size: 28px;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      transition: color 0.3s ease;
      background: none;
      border: none;
      padding: 0;
    }

    .close-modal:hover {
      color: #333;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-secondary {
      background: linear-gradient(45deg, #999, #777);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .reorder-buttons {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }

    .btn-reorder {
        background: linear-gradient(45deg, #ffffff, #ffffff);
        color: rgb(0, 0, 0);
        border: none;
        padding: 4px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        font-weight: 600;
        transition: all 0.3s ease; 
        min-width: 40px;
    }

    .btn-reorder:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px #45a04933;
    }

    .btn-reorder:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .target-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }

    .results-section {
      margin-top: 30px;
    }

    .results-table {
      background: white;
      border-radius: 15px;
      overflow-x: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    th {
      background: linear-gradient(45deg, #4caf50, #45a049);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .sortable-placeholder {
      height: 95px;
      background: linear-gradient(45deg, #e3f2fd, #bbdefb);
      border: 2px dashed #2196f3;
      border-radius: 25px;
      margin-bottom: 15px;
    }

    .priority-badge {
      background: #4caf50;
      color: white;
      padding: 6px 8px 4px 8px;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: 900;
      height: -webkit-fill-available;
    }

    .amount-format {
      font-family: "Courier New", monospace;
    }

    /* Daftar target jadi kartu vertikal */
    .target-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
    }

    .target-header {
      width: 100%;
      display: flex;
      justify-content: space-between; 
    }

    .d-none {
      display: none !important;
    }
   /* Mobile-friendly tweaks */
@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .target-item {
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }

  .content {
    grid: 10px;
  }

  .section-wrap {
    padding: 15px;
  }

  .target-inputs {
    flex-direction: column;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .header h1 {
    font-size: 1.6rem;
  }

  table {
    min-width: 500px;
  }

  .target-inputs {
    flex-direction: column;
    gap: 10px;
  }

  .target-inputs .form-group,
  .target-inputs button {
    width: 100% !important;
  }

  .btn {
    width: 100%;
  }

  /* Keep tutorial button compact on mobile */
  .btn-tutorial {
    width: auto !important;
    padding: 8px 12px;
    font-size: 0.9rem;
    white-space: nowrap;
    flex: 0 0 auto;
  }

  /* Mobile vertical card layout */
  .target-header {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .target-header > div:first-child {
    display: flex;
    align-items: center;
    gap: 10px;
    order: 1;
  }

  .target-header > div:last-child {
    display: flex;
    justify-content: space-between;
    align-items: center;
    order: 2;
    padding-top: 10px;
    border-top: 1px solid #e1e5e9;
  }

  .target-name {
    font-size: 1.1rem;
  }

  .target-amount {
    font-size: 1rem;
  }

  .drag-handle {
    font-size: 1rem;
  }
}
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’° Kalkulator Target Tabungan</h1>
      <p>Rencanakan masa depan finansial Anda dengan mudah</p>
    </div>

    <div class="content">
      <div class="section-wrap">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <div class="form-group mb-1" style="flex: 2; min-width: 250px;">
            <label for="monthly-saving">ğŸ’µ Tabungan Per Bulan (Rp)</label>
            <input type="number" id="monthly-saving" class="form-control" placeholder="Masukkan jumlah tabungan bulanan" min="0" />
          </div>
          <div class="form-group mb-1" style="flex: 1; min-width: 200px;">
            <label for="start-month">ğŸ“… Mulai Menabung</label>
            <select id="start-month" class="form-control" style="cursor: pointer;">
              <option value="current">Bulan Ini</option>
              <option value="next">Bulan Depan</option>
            </select>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button class="btn btn-tutorial" onclick="openTutorialModal()" style="flex: 0 0 auto; padding: 12px 20px;">
            ğŸ“– Tutorial
          </button>
          <button class="btn" onclick="openAddModal()" style="flex: 1;">
            âœš Tambah Target
          </button>
        </div>
      </div>  

      <div id="targets-section" class="section-wrap" style="display: none"> 

        <h3 style="margin-bottom: 20px; color: #333">
          ğŸ† Daftar Target (Seret untuk mengubah prioritas)
        </h3>
        <div id="targets-list"></div>
      <button class="btn" onclick="calculateResults()" style="margin-top: 20px; display: block; width: 100%">
        â¤ Hitung Timeline
      </button>
      </div>

      <div id="results-section" class="results-section" style="display: none">
        <h3 style="margin-bottom: 20px; color: #333">
          ğŸ“… Timeline Pencapaian Target
        </h3>
        <div class="results-table">
          <table>
            <thead>
              <tr>
                <th>Tahun</th>
                <th>Bulan</th>
                <th>Target Tercapai</th>
                <th>Nominal Target</th>
              </tr>
            </thead>
            <tbody id="results-body"></tbody>
            <tfoot id="results-footer">
              <tr style="background: #e8f5e8; font-weight: bold;">
                <td colspan="12" style="padding: 12px; border-top: 3px solid #4caf50;">
                  <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; text-align: center;">
                    <div>
                      <div style="color: #666; font-size: 0.9rem; font-weight: normal;">â±ï¸ Durasi</div>
                      <div style="color: #4caf50; font-size: 1.2rem;" id="summary-duration">-</div>
                    </div>
                    <div>
                      <div style="color: #666; font-size: 0.9rem; font-weight: normal;">ğŸ¯ Total Target</div>
                      <div style="color: #4caf50; font-size: 1.2rem;" id="summary-targets">-</div>
                    </div>
                    <div>
                      <div style="color: #666; font-size: 0.9rem; font-weight: normal;">ğŸ’° Total Nilai</div>
                      <div style="color: #4caf50; font-size: 1.2rem;" class="amount-format" id="summary-total">-</div>
                    </div>
                  </div>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <h3 style="margin: 30px 0 20px 0; color: #333">
          ğŸ” Timeline Pencapaian Target Per Bulan
        </h3>
        <div class="results-table">
          <table>
            <thead>
              <tr>
                <th>Tahun</th>
                <th>Bulan</th>
                <th>Saldo Awal</th>
                <th>Tabungan Bulanan</th>
                <th>Saldo Akhir</th>
                <th>Target Tercapai</th>
                <th>Sisa Anggaran</th>
              </tr>
            </thead>
            <tbody id="monthly-timeline-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Target Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ Edit Target</h2>
        <button class="close-modal" onclick="closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="modal-target-name">Nama Target</label>
          <input type="text" id="modal-target-name" class="form-control" />
        </div>
        <div class="form-group">
          <label for="modal-target-amount">Nominal Target (Rp)</label>
          <input type="number" id="modal-target-amount" class="form-control" min="0" />
        </div>
        <div class="form-group">
          <label for="modal-current-balance">ğŸ’° Nominal Tercapai (Rp)</label>
          <input type="number" id="modal-current-balance" class="form-control" min="0" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">Batal</button>
        <button class="btn btn-danger" onclick="deleteTargetFromModal()">ğŸ—‘ï¸ Hapus</button>
        <button class="btn" onclick="saveTargetEdit()">ğŸ’¾ Simpan</button>
      </div>
    </div>
  </div>

  <!-- Add Target Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœš Tambah Target Baru</h2>
        <button class="close-modal" onclick="closeAddModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="add-target-name">Nama Target</label>
          <input type="text" id="add-target-name" class="form-control" placeholder="Cth: Motor Baru" />
        </div>
        <div class="form-group">
          <label for="add-target-amount">Nominal Target (Rp)</label>
          <input type="number" id="add-target-amount" class="form-control" placeholder="Cth: 20.000.000" min="0" />
        </div>
        <div class="form-group">
          <label for="add-current-balance">ğŸ’° Nominal Tercapai (Rp)</label>
          <input type="number" id="add-current-balance" class="form-control" placeholder="Saldo saat ini: 0" min="0" value="0" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAddModal()">Batal</button>
        <button class="btn" onclick="saveNewTarget()">âœš Tambah Target</button>
      </div>
    </div>
  </div>

  <!-- Tutorial Modal -->
  <div id="tutorialModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>ğŸ“– Cara Menggunakan Aplikasi</h2>
        <button class="close-modal" onclick="closeTutorialModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="text-align: left;">
          <h3 style="color: #4caf50; margin-bottom: 15px;">ğŸ¯ Langkah-langkah:</h3>
          
          <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 8px;">1ï¸âƒ£ Masukkan Tabungan Bulanan</h4>
            <p style="color: #666; margin-left: 20px;">Isi jumlah uang yang bisa Anda sisihkan setiap bulan untuk menabung.</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 8px;">2ï¸âƒ£ Pilih Mulai Menabung</h4>
            <p style="color: #666; margin-left: 20px;">Pilih apakah ingin mulai menabung bulan ini atau bulan depan.</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 8px;">3ï¸âƒ£ Tambah Target</h4>
            <p style="color: #666; margin-left: 20px;">Klik tombol "Tambah Target Baru" untuk menambahkan target tabungan Anda:</p>
            <ul style="color: #666; margin-left: 40px;">
              <li>Nama Target (contoh: Motor, Nikah, Haji)</li>
              <li>Nominal Target (jumlah uang yang ingin dicapai)</li>
              <li>Nominal Tercapai (jika sudah punya tabungan untuk target ini)</li>
            </ul>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 8px;">4ï¸âƒ£ Atur Prioritas</h4>
            <p style="color: #666; margin-left: 20px;">Seret target atau gunakan tombol â–² â–¼ untuk mengubah urutan prioritas. Target paling atas akan dicapai lebih dulu.</p>
          </div>

          <div style="margin-bottom: 20px;">
            <h4 style="color: #333; margin-bottom: 8px;">5ï¸âƒ£ Hitung Timeline</h4>
            <p style="color: #666; margin-left: 20px;">Klik "Hitung Timeline" untuk melihat kapan setiap target akan tercapai dan rincian tabungan per bulan.</p>
          </div>

          <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-top: 20px;">
            <h4 style="color: #856404; margin-bottom: 8px;">ğŸ’¡ Tips:</h4>
            <ul style="color: #856404; margin-left: 20px;">
              <li>Data Anda tersimpan otomatis di browser</li>
              <li>Klik âš™ï¸ untuk mengedit atau menghapus target</li>
              <li>Timeline otomatis update saat Anda mengubah urutan target</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeTutorialModal()">Mengerti</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONSTANTS
    // ============================================
    const STORAGE_KEY = "savingsCalculatorData";
    const MONTHS_PER_YEAR = 12;
    const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
    const ANIMATION_DURATION = 300;

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let targets = [];
    let targetIdCounter = 1;
    let currentEditingTargetId = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    $(document).ready(function () {
      initializeSortable();
      loadFromStorage();
      attachEventListeners();
    });

    function initializeSortable() {
      $("#targets-list").sortable({
        handle: ".drag-handle",
        placeholder: "sortable-placeholder",
        update: updateTargetOrder
      });
    }

    function attachEventListeners() {
      $("#monthly-saving").on("input", saveToStorage);
      $("#start-month").on("change", saveToStorage);
      
      $(window).click(function (event) {
        if (event.target === $("#editModal")[0]) closeEditModal();
        if (event.target === $("#addModal")[0]) closeAddModal();
        if (event.target === $("#tutorialModal")[0]) closeTutorialModal();
      });
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function formatRupiah(number) {
      return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
      }).format(number);
    }

    function formatMonth(month) {
      return MONTH_NAMES[month - 1];
    }

    function getStartDate() {
      const currentDate = new Date();
      let year = currentDate.getFullYear();
      let month = currentDate.getMonth() + 1;

      if ($("#start-month").val() === "next") {
        month++;
        if (month > MONTHS_PER_YEAR) {
          month = 1;
          year++;
        }
      }

      return { year, month };
    }

    function normalizeMonth(month, year) {
      let normalizedMonth = month;
      let normalizedYear = year;

      while (normalizedMonth > MONTHS_PER_YEAR) {
        normalizedMonth -= MONTHS_PER_YEAR;
        normalizedYear++;
      }

      return { month: normalizedMonth, year: normalizedYear };
    }

    function calculateDurationText(totalMonths) {
      const years = Math.floor(totalMonths / MONTHS_PER_YEAR);
      const months = totalMonths % MONTHS_PER_YEAR;

      if (years > 0 && months > 0) {
        return `${years} Tahun ${months} Bulan`;
      } else if (years > 0) {
        return `${years} Tahun`;
      } else {
        return `${months} Bulan`;
      }
    }

    function shouldRecalculateResults() {
      return $("#results-section").is(":visible") && $("#monthly-saving").val();
    }

    // ============================================
    // LOCAL STORAGE MANAGEMENT
    // ============================================
    function saveToStorage() {
      const data = {
        targets,
        targetIdCounter,
        monthlySaving: $("#monthly-saving").val(),
        startMonth: $("#start-month").val(),
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return;

        const parsedData = JSON.parse(data);
        targets = parsedData.targets || [];
        targetIdCounter = parsedData.targetIdCounter || 1;

        if (parsedData.monthlySaving) {
          $("#monthly-saving").val(parsedData.monthlySaving);
        }

        if (parsedData.startMonth) {
          $("#start-month").val(parsedData.startMonth);
        }

        if (targets.length > 0) {
          $("#targets-section").show();
          renderTargets();
        }
      } catch (error) {
        console.error("Error loading from storage:", error);
      }
    }

    // ============================================
    // TARGET CRUD OPERATIONS
    // ============================================
    function addTarget() {
      const name = $("#add-target-name").val().trim();
      const amount = parseInt($("#add-target-amount").val());
      const currentBalance = parseInt($("#add-current-balance").val()) || 0;

      if (!validateTargetInput(name, amount)) return;

      const target = createTarget(name, amount, currentBalance);
      targets.push(target);
      
      updateUIAfterTargetChange();
      clearAddModalInputs();
      $("#targets-section").show();
    }

    function createTarget(name, amount, currentBalance) {
      return {
        id: targetIdCounter++,
        name,
        amount,
        currentBalance,
        priority: targets.length + 1,
      };
    }

    function validateTargetInput(name, amount) {
      if (!name || !amount || amount <= 0) {
        alert("Mohon isi nama target dan nominal yang valid!");
        return false;
      }
      return true;
    }

    function clearAddModalInputs() {
      $("#add-target-name").val("");
      $("#add-target-amount").val("");
      $("#add-current-balance").val("0");
    }

    function removeTarget(id) {
      targets = targets.filter((target) => target.id !== id);
      updateUIAfterTargetChange();

      if (targets.length === 0) {
        $("#targets-section").hide();
        $("#results-section").hide();
      }
    }

    function updateUIAfterTargetChange() {
      renderTargets();
      saveToStorage();
    }

    // ============================================
    // TARGET REORDERING
    // ============================================
    function moveTargetUp(targetId) {
      moveTarget(targetId, -1);
    }

    function moveTargetDown(targetId) {
      moveTarget(targetId, 1);
    }

    function moveTarget(targetId, direction) {
      const currentIndex = targets.findIndex((t) => t.id === targetId);
      const newIndex = currentIndex + direction;

      if (newIndex < 0 || newIndex >= targets.length) return;

      [targets[currentIndex], targets[newIndex]] = [targets[newIndex], targets[currentIndex]];
      
      updateUIAfterTargetChange();
      if (shouldRecalculateResults()) {
        calculateResults();
      }
    }

    function updateTargetOrder() {
      const newOrder = [];
      $("#targets-list .target-item").each(function () {
        const id = parseInt($(this).data("id"));
        const target = targets.find((t) => t.id === id);
        if (target) newOrder.push(target);
      });

      targets = newOrder;
      targets.forEach((target, index) => {
        target.id = index + 1;
        target.priority = index + 1;
      });

      updateUIAfterTargetChange();
      if (shouldRecalculateResults()) {
        calculateResults();
      }
    }

    // ============================================
    // TARGET RENDERING
    // ============================================
    function renderTargets() {
      const targetsList = $("#targets-list");
      targetsList.empty();

      targets.forEach((target, index) => {
        const targetElement = createTargetElement(target, index);
        targetsList.append(targetElement);
      });
    }

    function createTargetElement(target, index) {
      const progressPercentage = ((target.currentBalance || 0) / target.amount * 100).toFixed(1);
      const isFirst = index === 0;
      const isLast = index === targets.length - 1;

      return `
        <div class="target-item" data-id="${target.id}">
          <div class="target-header drag-handle">
            <div style="display: flex; align-items: center; gap: 15px;">
              <span class="priority-badge">${index + 1}</span>
              <div>
                <div class="target-name">${target.name}</div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                  ğŸ’° ${formatRupiah(target.currentBalance || 0)} â€¢ ${progressPercentage}% 
                </div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <div class="target-amount amount-format">${formatRupiah(target.amount)}</div>
              <div class="drag-handle">â‹®â‹®</div>
              <div class="reorder-buttons">
                <button class="btn-reorder ${isFirst ? 'd-none' : ''}" 
                        onclick="moveTargetUp(${target.id})" 
                        ${isFirst ? 'disabled' : ''}>â–²</button>
                <button class="btn-reorder ${isLast ? 'd-none' : ''}" 
                        onclick="moveTargetDown(${target.id})" 
                        ${isLast ? 'disabled' : ''}>â–¼</button>
              </div>
              <button class="btn" 
                      onclick="openEditModal(${target.id})" 
                      style="background: linear-gradient(60deg, #4aa94e, #081208);color: #000;font-size: 20px;padding: 10px;box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);">âš™ï¸</button>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // CALCULATION ENGINE
    // ============================================
    function calculateResults() {
      const monthlySaving = parseInt($("#monthly-saving").val());

      if (!monthlySaving || monthlySaving <= 0) {
        alert("Mohon isi jumlah tabungan bulanan yang valid!");
        return;
      }

      if (targets.length === 0) {
        alert("Mohon tambahkan minimal satu target!");
        return;
      }

      const { year: startYear, month: startMonth } = getStartDate();
      const targetCompletions = calculateTargetCompletions(monthlySaving, startYear, startMonth);
      const results = groupTargetsByMonth(targetCompletions, startYear, startMonth);

      renderTimeline(results, targetCompletions);
      renderMonthlyTimeline(monthlySaving, targets);
      $("#results-section").show();
    }

    function calculateTargetCompletions(monthlySaving, startYear, startMonth) {
      const completions = [];
      let totalSavingNeeded = 0;

      targets.forEach((target, index) => {
        const remainingAmount = target.amount - (target.currentBalance || 0);
        if (remainingAmount > 0) {
          totalSavingNeeded += remainingAmount;
        }

        const monthsNeeded = Math.ceil(totalSavingNeeded / monthlySaving);
        const { month, year } = normalizeMonth(startMonth + monthsNeeded - 1, startYear);

        completions.push({
          target,
          year,
          month,
          priority: index + 1,
          remainingAmount,
        });
      });

      return completions;
    }

    function groupTargetsByMonth(targetCompletions, startYear, startMonth) {
      const results = [];
      const maxYear = Math.max(...targetCompletions.map((t) => t.year));

      for (let year = startYear; year <= maxYear; year++) {
        const monthStart = year === startYear ? startMonth : 1;
        
        for (let month = monthStart; month <= MONTHS_PER_YEAR; month++) {
          const completedTargets = targetCompletions.filter(
            (t) => t.year === year && t.month === month
          );

          if (completedTargets.length > 0) {
            results.push({ year, month, targets: completedTargets });
          }
        }
      }

      return results;
    }

    // ============================================
    // TIMELINE RENDERING
    // ============================================
    function renderTimeline(results, allTargets) {
      const tbody = $("#results-body");
      tbody.empty();

      if (results.length === 0) {
        tbody.append('<tr><td colspan="4" style="text-align: center; padding: 30px;">Tidak ada hasil untuk ditampilkan</td></tr>');
        return;
      }

      updateTimelineHeader();
      renderTimelineRows(tbody, allTargets);
      updateTimelineSummary(allTargets);
    }

    function updateTimelineHeader() {
      const theadHtml = `
        <tr>
          <th>Tahun</th>
          <th>Bulan</th>
          <th>Target Tercapai</th>
          <th>Nominal Target</th>
        </tr>
      `;
      $("#results-body").closest("table").find("thead").html(theadHtml);
    }

    function renderTimelineRows(tbody, allTargets) {
      allTargets.forEach((targetCompletion) => {
        const row = `
          <tr>
            <td><strong>${targetCompletion.year}</strong></td>
            <td><strong>${formatMonth(targetCompletion.month)}</strong></td>
            <td style="font-weight: 600;">${targetCompletion.target.name}</td>
            <td style="font-weight: 600;" class="amount-format">${formatRupiah(targetCompletion.target.amount)}</td>
          </tr>
        `;
        tbody.append(row);
      });
    }

    function updateTimelineSummary(allTargets) {
      if (allTargets.length === 0) return;

      const totalTargets = allTargets.length;
      const totalValue = allTargets.reduce((sum, t) => sum + t.target.amount, 0);
      
      const firstTarget = allTargets[0];
      const lastTarget = allTargets[allTargets.length - 1];
      const totalMonths = (lastTarget.year - firstTarget.year) * MONTHS_PER_YEAR + 
                         (lastTarget.month - firstTarget.month) + 1;

      $("#summary-duration").text(calculateDurationText(totalMonths));
      $("#summary-targets").text(`${totalTargets} Target`);
      $("#summary-total").text(formatRupiah(totalValue));
    }

    // ============================================
    // MONTHLY TIMELINE RENDERING
    // ============================================
    function renderMonthlyTimeline(monthlySaving, targetsParam) {
      const tbody = $("#monthly-timeline-body");
      tbody.empty();

      const { year: startYear, month: startMonth } = getStartDate();
      const remainingTargets = getRemainingTargets();
      const targetSchedule = calculateTargetSchedule(remainingTargets, monthlySaving, startYear, startMonth);

      let currentBalance = remainingTargets.length > 0 ? (remainingTargets[0].currentBalance || 0) : 0;
      let monthIndex = 0;

      while (remainingTargets.length > 0) {
        const { month, year } = normalizeMonth(startMonth + monthIndex, startYear);
        monthIndex++;

        const monthData = processMonth(
          year, month, currentBalance, monthlySaving, 
          remainingTargets, targetSchedule
        );

        tbody.append(createMonthlyRow(year, month, monthData, monthlySaving));
        currentBalance = monthData.nextBalance;
      }

      appendFinalStatus(tbody, remainingTargets);
    }

    function getRemainingTargets() {
      return targets
        .map((target) => ({
          ...target,
          remainingAmount: target.amount - (target.currentBalance || 0),
        }))
        .filter((target) => target.remainingAmount > 0);
    }

    function calculateTargetSchedule(remainingTargets, monthlySaving, startYear, startMonth) {
      let cumulativeSaving = 0;
      
      return remainingTargets.map((target) => {
        cumulativeSaving += target.remainingAmount;
        const monthsNeeded = Math.ceil(cumulativeSaving / monthlySaving);
        const { month, year } = normalizeMonth(startMonth + monthsNeeded - 1, startYear);

        return {
          target,
          year,
          month,
          cumulativeNeeded: cumulativeSaving
        };
      });
    }

    function processMonth(year, month, balance, monthlySaving, remainingTargets, targetSchedule) {
      const startingBalance = balance;
      const balanceAfterSaving = balance + monthlySaving;
      const achievedTargets = [];
      let totalSpentThisMonth = 0;

      const targetsToAchieve = targetSchedule.filter(
        (scheduled) =>
          scheduled.year === year &&
          scheduled.month === month &&
          remainingTargets.some((remaining) => remaining.id === scheduled.target.id)
      );

      targetsToAchieve.forEach((scheduled) => {
        const targetIndex = remainingTargets.findIndex((t) => t.id === scheduled.target.id);
        if (targetIndex !== -1) {
          const target = remainingTargets[targetIndex];
          achievedTargets.push(target);
          totalSpentThisMonth += target.amount;
          remainingTargets.splice(targetIndex, 1);
        }
      });

      const sisaAnggaran = balanceAfterSaving - totalSpentThisMonth;
      const nextBalance = achievedTargets.length > 0 && remainingTargets.length > 0
        ? sisaAnggaran + (remainingTargets[0].currentBalance || 0)
        : sisaAnggaran;

      return {
        startingBalance,
        balanceAfterSaving,
        achievedTargets,
        sisaAnggaran,
        nextBalance
      };
    }

    function createMonthlyRow(year, month, data, monthlySaving) {
      const targetAchieved = data.achievedTargets.length > 0
        ? data.achievedTargets.map((t) => `${t.name} - ${formatRupiah(t.amount)}`).join("<br> ")
        : "-";

      const bgColor = data.achievedTargets.length > 0 ? 'style="background: #e8f5e8;"' : '';

      return `
        <tr ${bgColor}>
          <td><strong>${year}</strong></td>
          <td><strong>${formatMonth(month)}</strong></td>
          <td class="amount-format">${formatRupiah(data.startingBalance)}</td>
          <td class="amount-format" style="color: #4CAF50; font-weight: 600;">+${formatRupiah(monthlySaving)}</td>
          <td class="amount-format">${formatRupiah(data.balanceAfterSaving)}</td>
          <td style="color: #4CAF50; font-weight: 600;">${targetAchieved}</td>
          <td class="amount-format"><strong>${data.achievedTargets.length > 0 ? formatRupiah(data.sisaAnggaran) : "-"}</strong></td>
        </tr>
      `;
    }

    function appendFinalStatus(tbody, remainingTargets) {
      if (remainingTargets.length > 0) {
        tbody.append(`
          <tr style="background: #fff3e0;">
            <td colspan="7" style="text-align: center; padding: 20px; color: #ff9800; font-weight: 600;">
              âš ï¸ Target yang belum tercapai: ${remainingTargets.map((t) => t.name).join(", ")}
            </td>
          </tr>
        `);
      } else {
        tbody.append(`
          <tr style="background: #e8f5e8;">
            <td colspan="7" style="text-align: center; padding: 20px; color: #4CAF50; font-weight: 600;">
              ğŸ‰ Semua target berhasil dicapai!
            </td>
          </tr>
        `);
      }
    }

    // ============================================
    // MODAL MANAGEMENT
    // ============================================
    
    // Add Modal
    function openAddModal() {
      clearAddModalInputs();
      showModal("#addModal");
    }

    function closeAddModal() {
      hideModal("#addModal");
    }

    function saveNewTarget() {
      addTarget();
      closeAddModal();
    }

    // Edit Modal
    function openEditModal(targetId) {
      const target = targets.find((t) => t.id === targetId);
      if (!target) return;

      currentEditingTargetId = targetId;
      $("#modal-target-name").val(target.name);
      $("#modal-target-amount").val(target.amount);
      $("#modal-current-balance").val(target.currentBalance || 0);

      showModal("#editModal");
    }

    function closeEditModal() {
      hideModal("#editModal", () => {
        currentEditingTargetId = null;
      });
    }

    function saveTargetEdit() {
      const name = $("#modal-target-name").val().trim();
      const amount = parseInt($("#modal-target-amount").val());
      const currentBalance = parseInt($("#modal-current-balance").val()) || 0;

      if (!validateTargetInput(name, amount)) return;

      const targetIndex = targets.findIndex((t) => t.id === currentEditingTargetId);
      if (targetIndex !== -1) {
        targets[targetIndex].name = name;
        targets[targetIndex].amount = amount;
        targets[targetIndex].currentBalance = currentBalance;

        updateUIAfterTargetChange();
        closeEditModal();

        if (shouldRecalculateResults()) {
          calculateResults();
        }
      }
    }

    function deleteTargetFromModal() {
      if (confirm("Apakah Anda yakin ingin menghapus target ini?")) {
        removeTarget(currentEditingTargetId);
        closeEditModal();
      }
    }

    // Tutorial Modal
    function openTutorialModal() {
      showModal("#tutorialModal");
    }

    function closeTutorialModal() {
      hideModal("#tutorialModal");
    }

    // Modal Helpers
    function showModal(selector) {
      $(selector).fadeIn(ANIMATION_DURATION);
    }

    function hideModal(selector, callback) {
      $(selector).fadeOut(ANIMATION_DURATION, callback);
    }
  </script>
</body>

</html>